<%- include('partials/header', { title: 'Generate Barcode' }) %>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Generate New Barcode</h3>
                </div>
                <div class="card-body">
                    <% if (error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i><%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% } %>

                    <form method="POST" action="/generate">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="issuedTo" class="form-label">
                                        <strong>Issued To *</strong>
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="issuedTo" name="issuedTo" 
                                           placeholder="Enter person's name or identifier" required
                                           value="<%= barcode ? barcode.issuedTo : '' %>">
                                    <div class="form-text">The name of the person this barcode is issued to.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="purpose" class="form-label">
                                        <strong>Purpose (Optional)</strong>
                                    </label>
                                    <input type="text" class="form-control" id="purpose" name="purpose" 
                                           placeholder="e.g., Event Access, Visitor Pass, Employee Entry"
                                           value="<%= barcode ? barcode.purpose : '' %>">
                                    <div class="form-text">Optional description for this barcode's intended use.</div>
                                </div>

                                <div class="mb-4">
                                    <label for="expiryHours" class="form-label">
                                        <strong>Expiration (Optional)</strong>
                                    </label>
                                    <select class="form-select" id="expiryHours" name="expiryHours">
                                        <option value="">No expiration</option>
                                        <option value="1">1 hour</option>
                                        <option value="4">4 hours</option>
                                        <option value="24">24 hours</option>
                                        <option value="168">1 week</option>
                                        <option value="720">30 days</option>
                                    </select>
                                    <div class="form-text">Set when this barcode should automatically expire.</div>
                                </div>

                                <!-- Access Schedule Section -->
                                <div class="row mb-4">
                                        <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-info text-dark">
                                            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Access Schedule</h5>
                                            </div>
                                            <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="activeDate" class="form-label">
                                                    <strong>Active Date</strong>
                                                    </label>
                                                    <input type="date" class="form-control" id="activeDate" name="activeDate"
                                                        min="<%= new Date().toISOString().split('T')[0] %>">
                                                    <div class="form-text">Only allow scanning on this specific date</div>
                                                </div>
                                                
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="allowEarlyAccess" name="allowEarlyAccess" value="true">
                                                    <label class="form-check-label" for="allowEarlyAccess">
                                                    Allow Early Access (Before Event Day)
                                                    </label>
                                                    <div class="form-text">If unchecked, scanning will be blocked before the active date</div>
                                                </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="activeTime" class="form-label">Start Time</label>
                                                    <input type="time" class="form-control" id="activeTime" name="activeTime" value="09:00">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="endTime" class="form-label">End Time</label>
                                                    <input type="time" class="form-control" id="endTime" name="endTime" value="17:00">
                                                </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>

                                <div class="mb-4">
                                    <label for="barcodeType" class="form-label">
                                        <strong>Barcode Type</strong>
                                    </label>
                                    <select class="form-select" id="barcodeType" name="barcodeType">
                                        <option value="qrcode" selected>QR Code (Recommended for phones)</option>
                                        <option value="code128">Code 128 (Standard barcode)</option>
                                    </select>
                                    <div class="form-text">QR codes work best with phone cameras.</div>
                                </div>

                                <!-- Barcode Colors Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label class="form-label"><strong>Barcode Colors</strong></label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="backgroundColor" class="form-label">Background Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="backgroundColor" 
                                                               name="backgroundColor" value="#FFFFFF" title="Choose background color">
                                                        <input type="text" class="form-control" value="#FFFFFF" id="backgroundColorText">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="foregroundColor" class="form-label">Barcode Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="foregroundColor" 
                                                               name="foregroundColor" value="#000000" title="Choose barcode color">
                                                        <input type="text" class="form-control" value="#000000" id="foregroundColorText">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="borderColor" class="form-label">Border Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="borderColor" 
                                                               name="borderColor" value="#000000" title="Choose border color">
                                                        <input type="text" class="form-control" value="#000000" id="borderColorText">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Color Presets -->
                                        <div class="mb-3">
                                            <label class="form-label">Quick Color Presets:</label>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-dark" onclick="setColors('#FFFFFF', '#000000', '#000000')">
                                                    Classic Black
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" onclick="setColors('#FFFFFF', '#007BFF', '#007BFF')">
                                                    Blue Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="setColors('#FFFFFF', '#28A745', '#28A745')">
                                                    Green Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" onclick="setColors('#FFFFFF', '#DC3545', '#DC3545')">
                                                    Red Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="setColors('#FFFF00', '#000000', '#000000')">
                                                    Yellow Background
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-barcode me-2"></i>Generate Barcode
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Scanning Tips</h5>
                                        <ul class="small">
                                            <li>Use <strong>QR Code</strong> for best phone camera scanning</li>
                                            <li>Ensure good lighting when scanning</li>
                                            <li>Hold phone steady 6-12 inches from code</li>
                                            <li>Download the image for printing</li>
                                            <li>Test scan immediately after generation</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <% if (barcode) { %>
                        <hr class="my-4">
                        
                        <div class="alert alert-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div>
                                    <h4 class="alert-heading mb-1">Barcode Generated Successfully!</h4>
                                    <p class="mb-0">This barcode can be scanned once for access verification.</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-dark text-white">
                                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Barcode Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <strong>Barcode Code:</strong>
                                            <div class="input-group mt-1">
                                                <input type="text" class="form-control scanner-input font-monospace" 
                                                       value="<%= barcode.code %>" readonly id="barcodeCode">
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="copyToClipboard('<%= barcode.code %>')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Unique identifier for this barcode</small>
                                        </div>

                                        <div class="mb-3">
                                            <strong>Issued To:</strong>
                                            <p class="mb-1 fs-5"><%= barcode.issuedTo %></p>
                                        </div>

                                        <% if (barcode.purpose) { %>
                                            <div class="mb-3">
                                                <strong>Purpose:</strong>
                                                <p class="mb-1"><%= barcode.purpose %></p>
                                            </div>
                                        <% } %>

                                        <% if (barcode.expiresAt) { %>
                                            <div class="mb-3">
                                                <strong>Expires:</strong>
                                                <p class="mb-1 text-warning">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <%= new Date(barcode.expiresAt).toLocaleString() %>
                                                </p>
                                            </div>
                                        <% } else { %>
                                            <div class="mb-3">
                                                <strong>Expires:</strong>
                                                <p class="mb-1 text-success">
                                                    <i class="fas fa-infinity me-1"></i>
                                                    No expiration
                                                </p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Scannable Barcode</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <!-- Schedule Information -->
                                        <% if (barcode.activeDate) { %>
                                            <div class="alert alert-info mb-3">
                                                <i class="fas fa-calendar-check me-2"></i>
                                                <strong>Scheduled Access:</strong> 
                                                Active on <strong><%= new Date(barcode.activeDate).toLocaleDateString() %></strong> 
                                                <% if (barcode.activeTime !== '00:00' || barcode.endTime !== '23:59') { %>
                                                    from <strong><%= barcode.activeTime %> to <%= barcode.endTime %></strong>
                                                <% } %>
                                                <% if (!barcode.allowEarlyAccess) { %>
                                                    <br><small class="text-warning"><i class="fas fa-ban me-1"></i>Early access disabled - scanning blocked before event day</small>
                                                <% } else { %>
                                                    <br><small class="text-success"><i class="fas fa-check me-1"></i>Early access enabled</small>
                                                <% } %>
                                            </div>
                                        <% } %>

                                        <!-- Large barcode display -->
                                      <!-- Sharp, Square Barcode Display -->
                                      <!-- Large, Scannable Barcode Display -->
                                    <div class="mb-3 p-3 border rounded bg-white text-center">
                                        <div class="barcode-container mx-auto" style="width: 100%; max-width: 500px; aspect-ratio: 1/1;">
                                            <img src="<%= barcode.image %>" 
                                                alt="Barcode <%= barcode.code %>" 
                                                class="barcode-image w-100 h-100"
                                                style="object-fit: contain; image-rendering: crisp-edges;"
                                                id="barcodeImage">
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-mobile-alt me-1"></i>
                                                <strong>Point your phone camera at this QR code</strong>
                                                <% if (barcode.activeDate) { %>
                                                    <br>Active on: <strong><%= new Date(barcode.activeDate).toLocaleDateString() %></strong>
                                                    from <strong><%= barcode.activeTime %> to <%= barcode.endTime %></strong>
                                                <% } %>
                                            </small>
                                        </div>
                                    </div>
                                        <div class="text-center mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-qrcode me-1"></i>
                                                Scan this high-quality QR code with your phone camera
                                                <% if (barcode.activeDate) { %>
                                                    • Active on: <strong><%= new Date(barcode.activeDate).toLocaleDateString() %></strong>
                                                <% } %>
                                            </small>
                                        </div>

                                        <!-- Access Information -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="card bg-light h-100">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-info-circle me-2 text-primary"></i>Access Details</h6>
                                                        <div class="text-start small">
                                                            <p class="mb-1"><strong>Code:</strong> <code><%= barcode.code %></code></p>
                                                            <p class="mb-1"><strong>Issued To:</strong> <%= barcode.issuedTo %></p>
                                                            <% if (barcode.purpose) { %>
                                                                <p class="mb-1"><strong>Purpose:</strong> <%= barcode.purpose %></p>
                                                            <% } %>
                                                            <% if (barcode.activeDate) { %>
                                                                <p class="mb-1"><strong>Active Date:</strong> <%= new Date(barcode.activeDate).toLocaleDateString() %></p>
                                                                <p class="mb-1"><strong>Time Window:</strong> <%= barcode.activeTime %> - <%= barcode.endTime %></p>
                                                            <% } else { %>
                                                                <p class="mb-1"><strong>Status:</strong> <span class="text-success">Always Active</span></p>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card bg-light h-100">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-shield-alt me-2 text-success"></i>Security Status</h6>
                                                        <div class="text-start small">
                                                            <% if (barcode.activeDate) { %>
                                                                <p class="mb-1 text-success">
                                                                    <i class="fas fa-check-circle me-1"></i>
                                                                    <strong>Time-Restricted Access</strong>
                                                                </p>
                                                                <p class="mb-1">• Only works on event day</p>
                                                                <p class="mb-1">• Prevents accidental early use</p>
                                                                <p class="mb-1">• Automatic date validation</p>
                                                            <% } else { %>
                                                                <p class="mb-1 text-info">
                                                                    <i class="fas fa-bolt me-1"></i>
                                                                    <strong>Instant Access</strong>
                                                                </p>
                                                                <p class="mb-1">• Works immediately</p>
                                                                <p class="mb-1">• First scan grants access</p>
                                                                <p class="mb-1">• No date restrictions</p>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Scan URLs -->
                                        <div class="mb-3">
                                            <strong>Mobile Scan URL:</strong>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm" 
                                                    value="<%= barcode.mobileUrl %>" readonly id="mobileUrl">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                        onclick="copyToClipboard('<%= barcode.mobileUrl %>')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Phones will open this URL when scanning the QR code</small>
                                        </div>

                                        <!-- Action buttons -->
                                        <div class="d-grid gap-2 d-md-block mb-3">
                                            <% const colors = barcode.colors || { background: 'FFFFFF', foreground: '000000', border: '000000' } %>
                                           <!-- Update download button to get larger image -->
                                                            <a href="/download/<%= barcode.code %>?bg=<%= colors.background %>&fg=<%= colors.foreground %>&border=<%= colors.border %>&size=800" 
                                                            class="btn btn-success me-2"
                                                            download="barcode-<%= barcode.code %>.png">
                                                                <i class="fas fa-download me-2"></i>Download Large QR Code
                                                            </a>
                                            <button class="btn btn-outline-primary me-2" onclick="printBarcode('<%= barcode.issuedTo %>', '<%= barcode.purpose %>', '<%= barcode.code %>', '<%= barcode.activeDate ? new Date(barcode.activeDate).toLocaleDateString() : '' %>', '<%= barcode.activeTime %>', '<%= barcode.endTime %>')">
                                                <i class="fas fa-print me-2"></i>Print
                                            </button>
                                            <a href="<%= barcode.mobileUrl %>" 
                                               class="btn btn-warning me-2"
                                               target="_blank">
                                                <i class="fas fa-mobile-alt me-2"></i>Test Mobile Scan
                                            </a>
                                            <a href="/generate" class="btn btn-outline-secondary">
                                                <i class="fas fa-plus me-2"></i>Generate Another
                                            </a>
                                        </div>

                                        <!-- Current Status Information -->
                                        <div class="alert alert-info small mt-2">
                                            <i class="fas fa-clock me-2"></i>
                                            <strong>Current Status:</strong> 
                                            <span id="currentStatus">
                                                <% if (barcode.activeDate) { %>
                                                    <% 
                                                    const now = new Date();
                                                    const today = new Date().toDateString();
                                                    const eventDay = new Date(barcode.activeDate).toDateString();
                                                    const currentTime = now.toTimeString().substring(0, 5);
                                                    %>
                                                    <% if (today < eventDay) { %>
                                                        <span class="text-warning">⏳ Will be active on <%= new Date(barcode.activeDate).toLocaleDateString() %></span>
                                                    <% } else if (today > eventDay) { %>
                                                        <span class="text-danger">❌ Access expired - was only for <%= new Date(barcode.activeDate).toLocaleDateString() %></span>
                                                    <% } else if (currentTime < barcode.activeTime) { %>
                                                        <span class="text-warning">⏳ Will be active at <%= barcode.activeTime %></span>
                                                    <% } else if (currentTime > barcode.endTime) { %>
                                                        <span class="text-danger">❌ Access ended at <%= barcode.endTime %></span>
                                                    <% } else { %>
                                                        <span class="text-success">✅ Active now until <%= barcode.endTime %></span>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="text-success">✅ Always active - no date restrictions</span>
                                                <% } %>
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                <strong>Server Time:</strong> <span id="serverTime"><%= new Date().toLocaleString() %></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize form defaults
document.addEventListener('DOMContentLoaded', function() {
    // Set default active date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const activeDateInput = document.getElementById('activeDate');
    if (activeDateInput) {
        activeDateInput.value = tomorrow.toISOString().split('T')[0];
    }
    
    // Auto-select barcode text when clicked
    const barcodeInput = document.getElementById('barcodeCode');
    if (barcodeInput) {
        barcodeInput.addEventListener('click', function() {
            this.select();
        });
    }
    
    // Sync color pickers with text inputs
    document.querySelectorAll('input[type="color"]').forEach(colorInput => {
        const textInput = colorInput.parentElement.querySelector('input[type="text"]');
        
        if (colorInput && textInput) {
            colorInput.addEventListener('input', function() {
                textInput.value = this.value;
            });
            
            textInput.addEventListener('input', function() {
                const colorInput = this.parentElement.querySelector('input[type="color"]');
                if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                    colorInput.value = this.value;
                }
            });
        }
    });
    
    // Time validation
    const endTimeInput = document.getElementById('endTime');
    if (endTimeInput) {
        endTimeInput.addEventListener('change', function() {
            const startTime = document.getElementById('activeTime').value;
            const endTime = this.value;
            
            if (startTime && endTime && startTime >= endTime) {
                alert('End time must be after start time');
                this.value = '17:00';
            }
        });
    }
});

// Color preset function
function setColors(bg, fg, border) {
    document.getElementById('backgroundColor').value = bg;
    document.getElementById('foregroundColor').value = fg;
    document.getElementById('borderColor').value = border;
    
    // Update text inputs
    document.getElementById('backgroundColorText').value = bg;
    document.getElementById('foregroundColorText').value = fg;
    document.getElementById('borderColorText').value = border;
}

// Print function - now takes parameters instead of using EJS variables
function printBarcode(issuedTo, purpose, code, activeDate, activeTime, endTime) {
    const barcodeImage = document.getElementById('barcodeImage');
    if (!barcodeImage) {
        alert('No barcode image found to print');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    
    // Build active date info string
    let activeDateInfo = '';
    if (activeDate) {
        activeDateInfo = `<strong>Active Date:</strong> ${activeDate}<br><strong>Time:</strong> ${activeTime} - ${endTime}<br>`;
    }
    
    printWindow.document.write(`
        <html>
            <head>
                <title>Print Barcode - ${issuedTo}</title>
                <style>
                    body { 
                        text-align: center; 
                        padding: 40px; 
                        font-family: Arial, sans-serif;
                    }
                    img { 
                        max-width: 100%; 
                        height: auto; 
                        border: 2px solid #333;
                        border-radius: 10px;
                    }
                    .details { 
                        margin: 20px 0; 
                        text-align: left;
                        display: inline-block;
                    }
                    .access-info {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin: 15px 0;
                    }
                </style>
            </head>
            <body>
                <h2>Access Barcode</h2>
                <div class="details">
                    <div class="access-info">
                        <strong>Issued To:</strong> ${issuedTo}<br>
                        ${purpose ? `<strong>Purpose:</strong> ${purpose}<br>` : ''}
                        <strong>Code:</strong> ${code}<br>
                        ${activeDateInfo}
                    </div>
                </div>
                <img src="${barcodeImage.src}" alt="Barcode ${code}">
                <p><small>Generated on ${new Date().toLocaleString()}</small></p>
                <script>
                    window.onload = function() { 
                        setTimeout(() => {
                            window.print();
                            setTimeout(() => window.close(), 500);
                        }, 500);
                    }
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Update server time every minute
function updateServerTime() {
    const now = new Date();
    const serverTimeElement = document.getElementById('serverTime');
    const serverTimeFormElement = document.getElementById('serverTimeForm');
    
    if (serverTimeElement) serverTimeElement.textContent = now.toLocaleString();
    if (serverTimeFormElement) serverTimeFormElement.textContent = now.toLocaleString();
}
setInterval(updateServerTime, 60000);
</script>

<%- include('partials/footer') %>