<%- include('partials/header', { title: 'Generate Barcode' }) %>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Generate New Barcode</h3>
                </div>
                <div class="card-body">
                    <% if (error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i><%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% } %>

                    <form method="POST" action="/generate">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="issuedTo" class="form-label">
                                        <strong>Issued To *</strong>
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="issuedTo" name="issuedTo" 
                                           placeholder="Enter person's name or identifier" required
                                           value="<%= barcode ? barcode.issuedTo : '' %>">
                                    <div class="form-text">The name of the person this barcode is issued to.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="purpose" class="form-label">
                                        <strong>Purpose (Optional)</strong>
                                    </label>
                                    <input type="text" class="form-control" id="purpose" name="purpose" 
                                           placeholder="e.g., Event Access, Visitor Pass, Employee Entry"
                                           value="<%= barcode ? barcode.purpose : '' %>">
                                    <div class="form-text">Optional description for this barcode's intended use.</div>
                                </div>

                                <div class="mb-4">
                                    <label for="expiryHours" class="form-label">
                                        <strong>Expiration (Optional)</strong>
                                    </label>
                                    <select class="form-select" id="expiryHours" name="expiryHours">
                                        <option value="">No expiration</option>
                                        <option value="1">1 hour</option>
                                        <option value="4">4 hours</option>
                                        <option value="24">24 hours</option>
                                        <option value="168">1 week</option>
                                        <option value="720">30 days</option>
                                    </select>
                                    <div class="form-text">Set when this barcode should automatically expire.</div>
                                </div>

                                <div class="mb-4">
                                    <label for="barcodeType" class="form-label">
                                        <strong>Barcode Type</strong>
                                    </label>
                                    <select class="form-select" id="barcodeType" name="barcodeType">
                                        <option value="qrcode" selected>QR Code (Recommended for phones)</option>
                                        <option value="code128">Code 128 (Standard barcode)</option>
                                    </select>
                                    <div class="form-text">QR codes work best with phone cameras.</div>
                                </div>

                                                                <!-- Add this section to your form, after the barcode type selection -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label class="form-label"><strong>Barcode Colors</strong></label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="backgroundColor" class="form-label">Background Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="backgroundColor" 
                                                            name="backgroundColor" value="#FFFFFF" title="Choose background color">
                                                        <input type="text" class="form-control" value="#FFFFFF" 
                                                            onchange="document.getElementById('backgroundColor').value = this.value">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="foregroundColor" class="form-label">Barcode Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="foregroundColor" 
                                                            name="foregroundColor" value="#000000" title="Choose barcode color">
                                                        <input type="text" class="form-control" value="#000000"
                                                            onchange="document.getElementById('foregroundColor').value = this.value">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="borderColor" class="form-label">Border Color</label>
                                                    <div class="input-group">
                                                        <input type="color" class="form-control form-control-color" id="borderColor" 
                                                            name="borderColor" value="#000000" title="Choose border color">
                                                        <input type="text" class="form-control" value="#000000"
                                                            onchange="document.getElementById('borderColor').value = this.value">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Color Presets -->
                                        <div class="mb-3">
                                            <label class="form-label">Quick Color Presets:</label>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-dark" onclick="setColors('#FFFFFF', '#000000', '#000000')">
                                                    Classic Black
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" onclick="setColors('#FFFFFF', '#007BFF', '#007BFF')">
                                                    Blue Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="setColors('#FFFFFF', '#28A745', '#28A745')">
                                                    Green Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" onclick="setColors('#FFFFFF', '#DC3545', '#DC3545')">
                                                    Red Theme
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="setColors('#FFFF00', '#000000', '#000000')">
                                                    Yellow Background
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-barcode me-2"></i>Generate Barcode
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Scanning Tips</h5>
                                        <ul class="small">
                                            <li>Use <strong>QR Code</strong> for best phone camera scanning</li>
                                            <li>Ensure good lighting when scanning</li>
                                            <li>Hold phone steady 6-12 inches from code</li>
                                            <li>Download the image for printing</li>
                                            <li>Test scan immediately after generation</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <% if (barcode) { %>
                        <hr class="my-4">
                        
                        <div class="alert alert-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div>
                                    <h4 class="alert-heading mb-1">Barcode Generated Successfully!</h4>
                                    <p class="mb-0">This barcode can be scanned once for access verification.</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-dark text-white">
                                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Barcode Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <strong>Barcode Code:</strong>
                                            <div class="input-group mt-1">
                                                <input type="text" class="form-control scanner-input font-monospace" 
                                                       value="<%= barcode.code %>" readonly id="barcodeCode">
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="copyToClipboard('<%= barcode.code %>')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Unique identifier for this barcode</small>
                                        </div>

                                        <div class="mb-3">
                                            <strong>Issued To:</strong>
                                            <p class="mb-1 fs-5"><%= barcode.issuedTo %></p>
                                        </div>

                                        <% if (barcode.purpose) { %>
                                            <div class="mb-3">
                                                <strong>Purpose:</strong>
                                                <p class="mb-1"><%= barcode.purpose %></p>
                                            </div>
                                        <% } %>

                                        <% if (barcode.expiresAt) { %>
                                            <div class="mb-3">
                                                <strong>Expires:</strong>
                                                <p class="mb-1 text-warning">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <%= new Date(barcode.expiresAt).toLocaleString() %>
                                                </p>
                                            </div>
                                        <% } else { %>
                                            <div class="mb-3">
                                                <strong>Expires:</strong>
                                                <p class="mb-1 text-success">
                                                    <i class="fas fa-infinity me-1"></i>
                                                    No expiration
                                                </p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Scannable Barcode</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-light" onclick="testScan()">
                                                <i class="fas fa-camera me-1"></i>Test Scan
                                            </button>
                                        </div>
                                    </div>
                                    <!-- In the barcode display section, replace the card body with: -->
                                   <!-- In the barcode display card, update the image section -->
<div class="card-body text-center">
    <!-- High-resolution barcode display -->
    <div class="mb-3 p-4 border rounded bg-white">
        <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <small>4K High-Resolution QR Code - Perfect for printing and scanning</small>
        </div>
        
        <img src="<%= barcode.image %>" 
             alt="Barcode <%= barcode.code %>" 
             class="barcode-image img-fluid"
             style="max-width: 400px; max-height: 400px; width: 100%; height: auto;"
             id="barcodeImage">
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-expand-arrows-alt me-1"></i>
                4K Resolution • Perfect Square • Optimized for Mobile Scanning
            </small>
        </div>
    </div>

    <!-- Quality information -->
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h6><i class="fas fa-camera me-2"></i>Image Quality</h6>
                    <ul class="small mb-0">
                        <li><strong>Resolution:</strong> 4K (3840x3840)</li>
                        <li><strong>Aspect Ratio:</strong> Perfect Square</li>
                        <li><strong>Format:</strong> PNG (Lossless)</li>
                        <li><strong>Optimized for:</strong> Mobile Scanning</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h6><i class="fas fa-mobile-alt me-2"></i>Scanning Tips</h6>
                    <ul class="small mb-0">
                        <li>Works with all phone cameras</li>
                        <li>Clear scanning from 6-24 inches</li>
                        <li>Perfect for printing &amp; posters</li>
                        <li>High contrast for reliability</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Download section with quality info -->
    <div class="mt-4">
        <strong>Download Options:</strong>
        <div class="btn-group mt-2" role="group">
            <a href="/download/<%= barcode.code %>?bg=<%= barcode.colors.background %>&fg=<%= barcode.colors.foreground %>&border=<%= barcode.colors.border %>" 
               class="btn btn-success"
               download="barcode-<%= barcode.code %>.png">
                <i class="fas fa-download me-2"></i>Download 4K PNG
            </a>
            <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split" 
                    data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">More download options</span>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="/download/<%= barcode.code %>?bg=<%= barcode.colors.background %>&fg=<%= barcode.colors.foreground %>&border=<%= barcode.colors.border %>&scale=20"
                       download="barcode-<%= barcode.code %>-hd.png">
                        <i class="fas fa-download me-2"></i>HD Version (Faster)
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="printBarcode()">
                        <i class="fas fa-print me-2"></i>Print Directly
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Instructions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Usage Instructions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6><i class="fas fa-mobile-alt me-2 text-primary"></i>For Phone Scanning</h6>
                                                <ul class="small">
                                                    <li>Download the image and share it</li>
                                                    <li>User opens image on their phone</li>
                                                    <li>Use phone camera to scan the QR code</li>
                                                    <li>Camera will detect and open verification link</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <h6><i class="fas fa-print me-2 text-success"></i>For Physical Printing</h6>
                                                <ul class="small">
                                                    <li>Download the barcode image</li>
                                                    <li>Print on paper or card</li>
                                                    <li>Ensure good contrast (black on white)</li>
                                                    <li>Test scan after printing</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <h6><i class="fas fa-shield-alt me-2 text-warning"></i>Security Notes</h6>
                                                <ul class="small">
                                                    <li>Each code works only once</li>
                                                    <li>Cannot be reused after scanning</li>
                                                    <li>Optional expiration for extra security</li>
                                                    <li>Keep codes secure until distribution</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testScan() {
    const instructions = document.getElementById('testScanInstructions');
    instructions.classList.toggle('d-none');
}

function printBarcode() {
    const barcodeImage = document.getElementById('barcodeImage');
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Print Barcode</title>
                <style>
                    body { text-align: center; padding: 20px; }
                    img { max-width: 100%; height: auto; }
                    .details { margin: 20px 0; }
                </style>
            </head>
            <body>
                <h2>Access Barcode</h2>
                <div class="details">
                    <strong>Issued To:</strong> <%= barcode ? barcode.issuedTo : '' %><br>
                    <% if (barcode && barcode.purpose) { %>
                        <strong>Purpose:</strong> <%= barcode.purpose %><br>
                    <% } %>
                    <strong>Code:</strong> <%= barcode ? barcode.code : '' %>
                </div>
                <img src="${barcodeImage.src}" alt="Barcode">
                <p><small>Generated on ${new Date().toLocaleString()}</small></p>
                <script>
                    window.onload = function() { window.print(); }
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Color preset function
function setColors(bg, fg, border) {
    document.getElementById('backgroundColor').value = bg;
    document.getElementById('foregroundColor').value = fg;
    document.getElementById('borderColor').value = border;
    
    // Update text inputs
    document.querySelectorAll('input[type="color"]').forEach(input => {
        input.nextElementSibling.value = input.value;
    });
}

// Sync color inputs
document.addEventListener('DOMContentLoaded', function() {
    // Sync color pickers with text inputs
    document.querySelectorAll('input[type="color"]').forEach(colorInput => {
        colorInput.addEventListener('input', function() {
            this.nextElementSibling.value = this.value;
        });
        
        colorInput.nextElementSibling.addEventListener('input', function() {
            const colorInput = this.previousElementSibling;
            if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                colorInput.value = this.value;
            }
        });
    });
});

// Update download link with color parameters
function updateDownloadLink() {
    const bg = document.getElementById('backgroundColor').value.replace('#', '');
    const fg = document.getElementById('foregroundColor').value.replace('#', '');
    const border = document.getElementById('borderColor').value.replace('#', '');
    
    const downloadBtn = document.querySelector('a[download]');
    if (downloadBtn && '<%= barcode %>') {
        const originalHref = downloadBtn.href.split('?')[0];
        downloadBtn.href = `${originalHref}?bg=${bg}&fg=${fg}&border=${border}`;
    }
}

// Call this when colors change
document.querySelectorAll('input[type="color"], .form-control').forEach(input => {
    input.addEventListener('input', updateDownloadLink);
});

// Auto-select barcode text when clicked
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeCode');
    if (barcodeInput) {
        barcodeInput.addEventListener('click', function() {
            this.select();
        });
    }
});
</script>

<%- include('partials/footer') %>